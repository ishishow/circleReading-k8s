# コンテナ上のアプリケーションのログ出力

- コンテナ上で起動するアプリケーションは基本的には標準出力とエラー出力にログを出力するようにしておくべきです。
- なぜなら、Kubernetes では標準出力と標準エラー出力に出力されたログを kubectl logs コマンドで表示できる仕組みになっているからです。
- 中長期的にログを安定保存するにはログを集約してクラスタ外部に転送することで後からいつでも利用できるようにしておくことが一般的です。
- 他の方法としては下記の２つの方法が考えられます。
  - アプリケーションが特定のファイルにログを書き出す。
  - アプリケーションからライブラリを使って直接外部に転送する
- これらの方法は各アプリケーションごとに転送する仕組みを導入するため、設定の柔軟性がます一方で管理コストが高くなります。さらに、「kubectl logs」でログを確認できないというデメリットもあります。
- アプリケーションが特定のファイルにログを出力する場合、出力したファイルを読み込んで転送するサイドカーコンテナや DaemonSet も作成する必要があります。また、ファイルの出力先には注意する必要があります。
- 例えば Pod のローカル領域に出力していた場合には、PersistentVolume を利用してクラスタ外の永続化領域に保存するなどして、欠損を防止するようにしましょう。
- また、アプリケーションがライブラリを使って外部に直接転送する場合、転送先を変更する際にはアプリケーション側の変更がぐ必要になります。他にもログ転送に関する設定がアプリケーション側と密結合になってしまうといったデメリットがあります。

## Fluentd によるログ集約

- Kubernetes 上で起動しているコンテナのログを中長期的に安定保存するためには、Fluentd を使ってクラスタ外部に転送する構成がおすすめです。
- Fluentd も Kubernetes と同じように CNCF がホストするプロジェクトの一つです。

- Fluentd を Kubernetes に組み込んで利用するには、DaemonSet を利用して各ノードに Fluentd の Pod を一つずつ起動する方法をとります。DaemonSet が作成する各ノードの Fluentd Pod は、同じノード上に起動している全コンテナのログを取得して転送します。
